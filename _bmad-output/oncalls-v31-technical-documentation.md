# OnCalls V31 - Technical Documentation Summary

**Generated:** 2025-12-19
**Project:** OncallsV31 - Medical On-Call Scheduling Platform
**Type:** Brownfield

---

## Architecture Overview

**Backend (Flask 2.3.2):**
- Location: `backend_prod/app/`
- Pattern: Controller → Service → Model (MVC)
- Controllers: Auth, Home, Member, Shift, Request, Volunteer, Report, OptionSync
- Database: MySQL via SQLAlchemy ORM

**Frontend (React 19.1.0 + Vite):**
- Location: `frontend_src/src/`
- Styling: Tailwind CSS v4.1.11
- Routing: React Router v6 with lazy loading
- API: Axios with JWT Bearer auth

---

## Key Database Tables

| Table | Model | Purpose |
|-------|-------|---------|
| `passwords` | Members | User accounts (misnamed legacy table) |
| `groups` | Groups | Organizations, payment status |
| `schedule` | Schedule | Shift assignments (composite PK) |
| `groupcalls` | Shift | Shift type definitions |
| `requests` | Requests | Time-off/coverage requests |
| `user_token` | TokenAuth | JWT token storage |
| `payments` | Payments | Stripe transaction records |

---

## Authentication Flow

1. Login via `/api/login` or Google OAuth
2. JWT tokens: 24h access, 48h refresh
3. Tokens stored in `user_token` table
4. `@requires_token` decorator validates on protected routes
5. **CRITICAL**: Passwords stored in PLAINTEXT (HIPAA violation)

---

## Critical Issues Identified

1. **data.fget() Bug** - `MemberService.py:56` - FIXED
2. **Plaintext Passwords** - Members.Password field - HIGH PRIORITY
3. **Race Conditions** - Stripe subscription updates
4. **Missing Input Validation** - Throughout services
5. **JWT Secret Regeneration** - Tokens invalidate on restart

---

## API Endpoints (Key)

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/login` | POST | User authentication |
| `/api/members` | GET/POST | Member management |
| `/api/home` | GET | Week schedule |
| `/api/month_schedule` | GET | Month schedule |
| `/api/shifts` | GET/POST | Shift configuration |
| `/api/create-checkout-session` | POST | Stripe payment |

---

## Deployment

**Servers:**
- Production: 159.203.167.125 (oncalls alias)
- Database: DigitalOcean MySQL (port 25060)
- CI/CD: GitHub Actions

**Environment:**
- Backend service: `oncalls_backend_gunicorn.service`
- Path: `/var/www/oncalls/current/`

---

**Full documentation generated by docs-architect agent.**
